<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Live 5-Room Energy Monitor + Conservation Tips</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#071021; --card:#0f1724; --muted:#9fb0bb; --accent:#06b6d4; --text:#e9f2f7; --bright:#00e5ff;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;padding:16px}
.app{max-width:1200px;margin:0 auto}
header{display:flex;justify-content:space-between;align-items:center;gap:12px}
h1{margin:0;font-size:1.1rem}
.controls{display:flex;gap:8px}
button{background:var(--accent);border:none;color:#041018;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:7px 10px;border-radius:8px;cursor:pointer}
main{display:grid;grid-template-columns:1fr 380px;gap:14px;margin-top:14px}
@media (max-width:980px){main{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
.metrics{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.metric{flex:1;min-width:140px;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
.metric h4{margin:0;color:var(--muted);font-size:0.85rem}
.metric .val{margin-top:6px;font-weight:700;font-size:1.2rem}
.rooms{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
@media (max-width:700px){.rooms{grid-template-columns:1fr}}
.room{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)}
.room h3{margin:0 0 6px 0}
.appliance{display:flex;gap:8px;align-items:center;margin:6px 0}
.appliance input[type=number]{width:70px;padding:6px;border-radius:6px;border:none;background:rgba(255,255,255,0.03);color:inherit}
.appliance label{flex:1}
.small{font-size:0.85rem;color:var(--muted)}
canvas{width:100%;height:220px}
.history{max-height:300px;overflow:auto;margin-top:8px}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6)}
.modal.show{display:flex}
.panel{width:880px;max-width:96%;background:var(--card);padding:18px;border-radius:12px}
input,select{padding:8px;border-radius:8px;border:none;margin-top:6px;background:rgba(255,255,255,0.02);color:inherit;width:100%}
.footer{margin-top:12px;color:var(--muted);font-size:0.85rem;text-align:center}
.budget-section label{color: var(--bright);}
.budget-section #budgetInput {color: var(--bright); font-weight: 700; background: rgba(0, 229, 255, 0.1); border: 1px solid var(--bright);}
.budget-section p{color: var(--bright); font-weight: 700;}
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>Live 5-Room Energy Monitor</h1>
      <div class="small">Interactive per-room live feed â€” add/remove appliances, edit wattages, CSV export</div>
    </div>
    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="stopBtn" class="btn-ghost">Stop</button>
      <button id="resetBtn" class="btn-ghost">Reset Day</button>
      <button id="exportBtn" class="btn-ghost">Export CSV</button>
      <button id="settingsBtn" class="btn-ghost">Settings</button>
    </div>
  </header>

  <main>
    <section>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Device</div>
            <div id="deviceName" style="font-weight:700">Simulated-5Room-Meter</div>
          </div>
          <div style="text-align:right">
            <div class="small">Interval</div>
            <div id="intervalLabel">1s</div>
          </div>
        </div>

        <div class="metrics">
          <div class="metric"><h4>Total Power</h4><div class="val" id="totalPower">0 W</div></div>
          <div class="metric"><h4>Total Energy (today)</h4><div class="val" id="totalEnergy">0.000 kWh</div></div>
          <div class="metric"><h4>Monthly Estimate</h4><div class="val" id="monthlyEst">0 kWh</div></div>
          <div class="metric"><h4>Estimated Cost</h4><div class="val">â‚¹ <span id="estCost">0.00</span></div></div>
        </div>

        <div style="margin-top:12px" class="card">
          <canvas id="powerChart"></canvas>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
          <label class="small">Simulation</label>
          <input id="simulateToggle" type="checkbox" checked />
          <label style="margin-left:16px" class="small">High-usage alert (kWh/day)</label>
          <input id="alertThreshold" type="number" value="1" style="width:120px;margin-left:6px" />
          <div style="margin-left:auto" class="small">History entries: <span id="histCount">0</span></div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0">Rooms & Appliances</h3>
        <div class="small">Toggle appliances ON/OFF or change wattage â€” totals update live.</div>

        <div class="rooms" id="roomsContainer"></div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="addRoomBtn" class="btn-ghost">+ Add Room</button>
          <button id="addApplianceGlobal" class="btn-ghost">+ Add Appliance to All</button>
        </div>
      </div>

      <!-- Conservation Tips card -->
      <div class="card" aria-label="Electricity conservation tips" style="margin-top: 20px;">
        <h3>Conservation Tips ðŸ’¡</h3>
        <ul id="tipsList" style="margin-left: 20px; list-style-type: disc; color: #a1eafb;"></ul>
      </div>

      <!-- Budget to Usage -->
      <div class="card budget-section" style="margin-top: 20px;">
        <h3>Budget to Usage ðŸ”„</h3>
        <label for="budgetInput">Monthly Budget (â‚¹)</label>
        <input id="budgetInput" type="number" min="0" step="0.01" value="1000" />
        <p>Max usage allowed: <span id="maxUsage">0.000</span> kWh</p>
      </div>
    </section>

    <aside>
      <div class="card">
        <h3 style="margin:0">Live Log</h3>
        <div class="small">Saved to browser storage (local)</div>
        <div class="history" id="historyArea"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="clearHistory" class="btn-ghost">Clear History</button>
          <button id="exportHistory" class="btn-ghost">Export CSV</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0">Quick Settings</h3>
        <label>Tariff (â‚¹ / kWh)</label>
        <input id="tariff" type="number" step="0.01" value="8" />
        <label>Update interval (ms)</label>
        <input id="updateInterval" type="number" min="200" value="1000" />
        <label>Chart window (points)</label>
        <input id="chartWindow" type="number" min="10" value="60" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="saveQuick" class="btn-ghost">Save</button>
          <button id="resetRooms" class="btn-ghost">Reset Rooms</button>
        </div>
      </div>
    </aside>
  </main>

  <div class="footer">Tip: open this file directly for simulation. To use a real meter API later, set the endpoint and run via HTTP (CORS may apply).</div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="panel">
    <h3>Advanced Settings</h3>
    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <label>Device name</label><input id="advDevice" type="text" value="Simulated-5Room-Meter" />
        <label>Simulation mode</label>
        <select id="advSimMode"><option value="smooth">Smooth</option><option value="step">Step</option><option value="constant">Constant</option></select>
        <label>Initial power (W)</label><input id="advPower" type="number" value="2500"/>
      </div>
      <div style="flex:1">
        <label>Initial energy (kWh)</label><input id="advEnergy" type="number" value="150"/>
        <label>History size (max entries)</label><input id="advHistoryMax" type="number" value="500"/>
        <label>Enable Notifications</label>
        <select id="advNotify"><option value="no">No</option><option value="yes">Yes</option></select>
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="modalClose" class="btn-ghost">Cancel</button>
      <button id="modalApply" class="btn-ghost">Apply</button>
    </div>
  </div>
</div>

<script>
const DEFAULT = {
  interval: 1000,
  chartWindow: 60,
  tariff: 8,
  simulate: true,
  simMode: 'smooth',
  alertThreshold: 1, // kWh daily per appliance alert threshold
  totalEnergy: 0,
  history: [],
  maxHistory: 500,
  rooms: [
    { id:'living', name:'Living Room', energy:100.0, appliances:[
      {name:'Ceiling Fan', watt:75, on:true, dailyEnergy:0},
      {name:'LED Light', watt:9, on:true, dailyEnergy:0},
      {name:'TV', watt:120, on:true, dailyEnergy:0}
    ]},
    { id:'kitchen', name:'Kitchen', energy:120.0, appliances:[
      {name:'Fridge', watt:200, on:true, dailyEnergy:0},
      {name:'Microwave', watt:800, on:false, dailyEnergy:0},
      {name:'Light', watt:20, on:true, dailyEnergy:0}
    ]},
    { id:'bed1', name:'Bedroom 1', energy:80.0, appliances:[
      {name:'AC', watt:1500, on:false, dailyEnergy:0},
      {name:'Fan', watt:75, on:true, dailyEnergy:0},
      {name:'Light', watt:9, on:true, dailyEnergy:0}
    ]},
    { id:'bed2', name:'Bedroom 2', energy:70.0, appliances:[
      {name:'Fan', watt:75, on:true, dailyEnergy:0},
      {name:'Light', watt:9, on:true, dailyEnergy:0}
    ]},
    { id:'bed3', name:'Bedroom 3', energy:60.0, appliances:[
      {name:'Fan', watt:75, on:true, dailyEnergy:0},
      {name:'Light', watt:9, on:true, dailyEnergy:0}
    ]},
    { id:'bed4', name:'Bedroom 4', energy:65.0, appliances:[
      {name:'Fan', watt:75, on:true, dailyEnergy:0},
      {name:'Light', watt:9, on:true, dailyEnergy:0}
    ]}
  ]
};

let state = loadState() || JSON.parse(JSON.stringify(DEFAULT));
state.applianceNotifiedToday = state.applianceNotifiedToday || {};
state.budgetExceededNotified = false;

const $ = id => document.getElementById(id);

function saveState(){ localStorage.setItem('live5_state', JSON.stringify(state)); }
function loadState(){ try{ return JSON.parse(localStorage.getItem('live5_state')||'null'); }catch(e){return null;} }

const ctx = $('powerChart').getContext('2d');
const chart = new Chart(ctx, {
  type:'line',
  data:{
    labels: Array(state.chartWindow).fill(''),
    datasets:[{
      label:'Total Power (W)',
      data: Array(state.chartWindow).fill(0),
      borderColor: 'var(--accent)',
      backgroundColor: 'rgba(6,182,212,0.15)',
      tension: 0.3,
      fill: true,
      pointRadius: 0
    }]
  },
  options:{
    animation:false,
    responsive:true,
    maintainAspectRatio:false,
    scales:{ y:{ beginAtZero:true } },
    plugins:{ legend:{ labels:{ color: 'var(--text)' } } }
  }
});

function renderRooms(){
  const container = $('roomsContainer'); container.innerHTML = '';
  state.rooms.forEach((room, rIdx) => {
    const div = document.createElement('div'); div.className='room'; div.id='room-'+room.id;
    div.innerHTML = `<h3>${room.name}</h3>
      <div class="small">Power: <span class="room-power">0 W</span></div>
      <div class="small">Energy: <span class="room-energy">${room.energy.toFixed(3)} kWh</span></div>
      <div class="applist"></div>`;
    const apList = div.querySelector('.applist');
    room.appliances.forEach((ap, aIdx) => {
      const apDiv = document.createElement('div'); apDiv.className='appliance';
      apDiv.innerHTML = `<label>${ap.name}</label>
        <input type="number" class="ap-watt" value="${ap.watt}" title="Watt">
        <input type="checkbox" class="ap-on" ${ap.on ? 'checked' : ''}>
        <button class="ap-remove">ðŸ—‘</button>`;
      apDiv.querySelector('.ap-watt').addEventListener('change', e=>{
        room.appliances[aIdx].watt = parseFloat(e.target.value) || 0; saveState(); updateAll();
      });
      apDiv.querySelector('.ap-on').addEventListener('change', e=>{
        room.appliances[aIdx].on = e.target.checked; saveState(); updateAll();
      });
      apDiv.querySelector('.ap-remove').addEventListener('click', ()=>{
        if(!confirm('Remove appliance?')) return;
        room.appliances.splice(aIdx,1); saveState(); renderRooms(); updateAll();
      });
      apList.appendChild(apDiv);
    });
    const addBtn = document.createElement('div'); addBtn.style.marginTop='8px';
    addBtn.innerHTML = <button class="btn-ghost add-ap">+ Add appliance</button>;
    addBtn.querySelector('.add-ap').addEventListener('click', ()=>{
      const name = prompt('Appliance name','New Appliance')||'New Appliance';
      const watt = parseFloat(prompt('Wattage (W)','100')||'100');
      room.appliances.push({name, watt, on:true, dailyEnergy:0});
      saveState(); renderRooms(); updateAll();
    });
    apList.appendChild(addBtn);
    container.appendChild(div);
  });
}

function calcRoomPower(room){
  return room.appliances.reduce((s,a)=> s + (a.on ? (parseFloat(a.watt)||0) : 0), 0);
}
function calcTotalPower(){
  return state.rooms.reduce((s,room)=> s + calcRoomPower(room), 0);
}
function updateChart(value){
  chart.data.datasets[0].data.push(value);
  chart.data.datasets[0].data.shift();
  chart.data.labels.push('');
  chart.data.labels.shift();
  chart.update('none');
}

function notify(msg){
  if(Notification.permission === 'granted'){
    new Notification('Energy Monitor', { body: msg });
  } else {
    alert(msg);
  }
}

const tips = [
  "Turn off appliances when not in use.",
  "Use energy-efficient LED bulbs.",
  "Unplug chargers when not charging.",
  "Use natural light during the day.",
  "Maintain appliances regularly.",
  "Use ceiling fans instead of AC when possible.",
  "Keep fridge temperature moderate.",
  "Avoid keeping doors/windows open when AC is on."
];
function renderTips(){
  const ul = $('tipsList');
  ul.innerHTML = '';
  tips.forEach(t=>{
    const li = document.createElement('li');
    li.textContent = t;
    ul.appendChild(li);
  });
}

function updateAll(){
  const intervalHours = state.interval / 3600000;
  let totalPower = 0;
  state.rooms.forEach(room=>{
    const roomPower = calcRoomPower(room);
    totalPower += roomPower;
    room.appliances.forEach(ap=>{
      if(ap.on){
        const deltaEnergy = (ap.watt / 1000) * intervalHours;
        ap.dailyEnergy = (ap.dailyEnergy || 0) + deltaEnergy;
        if(ap.dailyEnergy > state.alertThreshold){
          const key = room.name + '-' + ap.name;
          if(!state.applianceNotifiedToday[key]){
            notify(High usage alert: ${ap.name} in ${room.name} exceeded ${state.alertThreshold} kWh today!);
            state.applianceNotifiedToday[key] = true;
          }
        }
      }
    });
    room.energy += (roomPower / 1000) * intervalHours;
  });

  state.totalEnergy = state.rooms.reduce((sum,r)=>sum+r.energy, 0);

  const estCost = state.totalEnergy * state.tariff;

  const budgetVal = parseFloat($('budgetInput').value) || 1000;
  const maxUsage = budgetVal / state.tariff;
  $('maxUsage').textContent = maxUsage.toFixed(3);

  if(estCost > budgetVal){
    if(!state.budgetExceededNotified){
      notify('Monthly cost exceeds your budget!');
      state.budgetExceededNotified = true;
    }
  } else {
    state.budgetExceededNotified = false;
  }

  $('totalPower').textContent = totalPower.toFixed(0) + ' W';
  $('totalEnergy').textContent = state.totalEnergy.toFixed(3) + ' kWh';
  $('monthlyEst').textContent = (state.totalEnergy * 30).toFixed(0) + ' kWh';
  $('estCost').textContent = estCost.toFixed(2);

  state.rooms.forEach(room=>{
    const div = $('room-'+room.id);
    if(div){
      div.querySelector('.room-power').textContent = calcRoomPower(room).toFixed(0) + ' W';
      div.querySelector('.room-energy').textContent = room.energy.toFixed(3) + ' kWh';
    }
  });

  updateChart(totalPower);

  const now = new Date();
  state.history.push({ timestamp: now.toISOString(), totalPower, totalEnergy: state.totalEnergy, cost: estCost });
  if(state.history.length > state.maxHistory) state.history.shift();
  updateHistoryUI();
  saveState();
}

function updateHistoryUI(){
  const hist = $('historyArea');
  hist.innerHTML = '';
  const len = state.history.length;
  $('histCount').textContent = len;
  const recent = state.history.slice(-20);
  recent.forEach(e=>{
    const div = document.createElement('div');
    div.className='history-item';
    div.innerHTML = <div>${new Date(e.timestamp).toLocaleTimeString()}</div><div>${e.totalPower.toFixed(0)} W / ${e.totalEnergy.toFixed(3)} kWh / â‚¹${e.cost.toFixed(2)}</div>;
    hist.appendChild(div);
  });
}

function resetDay(){
  if(!confirm('Reset daily energy counters?')) return;
  state.rooms.forEach(room=>{
    room.appliances.forEach(ap=>ap.dailyEnergy=0);
    room.energy=0;
  });
  state.totalEnergy=0;
  state.applianceNotifiedToday = {};
  state.budgetExceededNotified = false;
  saveState();
  updateAll();
}

function exportCSV(){
  let csv = 'Timestamp,Total Power (W),Total Energy (kWh),Cost (â‚¹)\n';
  state.history.forEach(e=>{
    csv += ${e.timestamp},${e.totalPower.toFixed(0)},${e.totalEnergy.toFixed(3)},${e.cost.toFixed(2)}\n;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'energy_history.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

let intervalHandle = null;
let isRunning = false;

function tick(){
  if(state.simulate){
    state.rooms.forEach(room=>{
      room.appliances.forEach(ap=>{
        if(Math.random() < 0.01) ap.on = !ap.on;
      });
    });
  }
  updateAll();
}

function startSimulation(){
  if(isRunning) return;
  isRunning = true;
  intervalHandle = setInterval(tick, state.interval);
}
function stopSimulation(){
  if(!isRunning) return;
  isRunning = false;
  clearInterval(intervalHandle);
}

function init(){
  renderRooms();
  renderTips();
  updateAll();
  Notification.requestPermission();

  $('intervalLabel').textContent = (state.interval/1000)+'s';
  $('simulateToggle').checked = state.simulate;
  $('alertThreshold').value = state.alertThreshold;
  $('budgetInput').value = 1000;
  $('tariff').value = state.tariff;
  $('updateInterval').value = state.interval;
  $('chartWindow').value = state.chartWindow;

  // event listeners
  $('startBtn').onclick = startSimulation;
  $('stopBtn').onclick = stopSimulation;
  $('resetBtn').onclick = resetDay;
  $('exportBtn').onclick = exportCSV;
  $('settingsBtn').onclick = ()=>$('modal').classList.add('show');
  $('modalClose').onclick = ()=>$('modal').classList.remove('show');

  $('modalApply').onclick = ()=>{
    state.deviceName = $('advDevice').value;
    state.simMode = $('advSimMode').value;
    state.totalEnergy = parseFloat($('advEnergy').value) || 0;
    state.maxHistory = parseInt($('advHistoryMax').value) || 500;
    state.notifyEnabled = $('advNotify').value === 'yes';
    $('modal').classList.remove('show');
    saveState();
  };

  $('simulateToggle').onchange = e=>{
    state.simulate = e.target.checked;
    saveState();
  };
  $('alertThreshold').onchange = e=>{
    state.alertThreshold = parseFloat(e.target.value);
    saveState();
  };
  $('budgetInput').oninput = e=>{
    saveState();
    updateAll();
  };
  $('tariff').oninput = e=>{
    state.tariff = parseFloat(e.target.value) || 8;
    saveState();
    updateAll();
  };
  $('updateInterval').oninput = e=>{
    let val = parseInt(e.target.value);
    if(val < 200) val = 200;
    state.interval = val;
    if(isRunning){
      clearInterval(intervalHandle);
      intervalHandle = setInterval(tick, state.interval);
    }
    saveState();
  };
  $('chartWindow').oninput = e=>{
    const val = parseInt(e.target.value);
    if(val < 10) return;
    state.chartWindow = val;
    chart.data.labels = Array(val).fill('');
    chart.data.datasets[0].data = Array(val).fill(0);
    chart.update();
    saveState();
  };

  $('addRoomBtn').onclick = ()=>{
    const name = prompt('Room name','New Room')||'New Room';
    state.rooms.push({id:'room'+Date.now(), name, energy:0, appliances:[]});
    saveState();
    renderRooms();
  };

  $('addApplianceGlobal').onclick = ()=>{
    const name = prompt('Appliance name','New Appliance')||'New Appliance';
    const watt = parseFloat(prompt('Wattage (W)','100')||'100');
    state.rooms.forEach(r=>r.appliances.push({name, watt, on:true, dailyEnergy:0}));
    saveState();
    renderRooms();
  };

  $('clearHistory').onclick = ()=>{
    if(confirm('Clear all history?')){
      state.history = [];
      saveState();
      updateHistoryUI();
    }
  };

  $('exportHistory').onclick = exportCSV;

  $('saveQuick').onclick = ()=>{
    state.tariff = parseFloat($('tariff').value) || 8;
    state.interval = parseInt($('updateInterval').value) || 1000;
    state.chartWindow = parseInt($('chartWindow').value) || 60;
    saveState();
    alert('Settings saved');
  };

  $('resetRooms').onclick = ()=>{
    if(confirm('Reset all rooms and appliances to defaults?')){
      state = JSON.parse(JSON.stringify(DEFAULT));
      state.applianceNotifiedToday = {};
      state.budgetExceededNotified = false;
      renderRooms();
      saveState();
      updateAll();
    }
  };
}

init();
</script>
</body>
</html>